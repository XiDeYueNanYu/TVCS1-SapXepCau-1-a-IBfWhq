<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>越南语-语法-排序练习</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            text-align: center;
            margin: 0;
            padding-bottom: 300px;
            background-color: #f7fbf3;
        }
        
        #gameContainer {
            min-height: calc(100vh - 150px);
        }
        
        #infoBox {
            width: 95%; 
            max-width: 700px;
            min-height: 100px; 
            margin: 0 auto; 
            border: 2px solid #72a9db; /*041b31 1f4263*/
            background: #63a0d8; /*ecf2e4 fefefc 63a0d8 */
            color: #ffffff; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            font-size: clamp(40px, 5vw, 60px);
            font-weight: bold;
        }
        
        #contactBox, #instructionBox {
            width: 90%;
            max-width: 700px;
            min-height: 25px;
            margin: 0px auto;
            border: 2px solid #72a9db;
            background: #63a0d8;
            color: #ffd300;
            padding-left: 20px;
            display: flex;
            align-items: center;
            font-size: clamp(16px, 2vw, 20px);
            font-weight: bold;
        }
        
        #instructionBox {
            color: #f7e19c;
        }

        #indicator, #indicator2 {
            width: 90%;
            max-width: 700px;
            min-height: 70px;
            margin: 15px auto;
            padding: 15px;
            border: 3px solid #fed16a;
            background: #ffffe0;
            border-radius: 5px;
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
            justify-content: center;
            align-items: center;
            font-size: clamp(32px, 5vw, 48px);
            font-weight: bold;
        }
        
        #indicator2 {
            background: #fffbef;
            border: 3px solid #ccc;
            min-height: 90px;
            transition: all .4s;
        }
        
        #indicator2.correct {
            background: #B7D7AA !important;
            border-color: #5ba346;
        }
        
        #indicator2.wrong {
            background: #ffcccc !important;
            border-color: #CE6D5E;
        }

        .word-btn {
            padding: 10px 20px;
            background: #fff;
            border: 2px solid #63a0d8;
            border-radius: 12px;
            font-size: clamp(32px, 5vw, 48px);
            cursor: pointer;
            user-select: none;
            box-shadow: 0 3px 6px rgba(0,0,0,.15);
            transition: all .2s;
            min-width: 60px;
            text-align: center;
        }
        
        .word-btn.used {
            opacity: 0.35;
            pointer-events: none;
        }
        
        .word-btn-in-answer {
            background: #ffd700 !important;
            animation: pop .3s;
        }
        
        @keyframes pop {
            0% { transform: scale(0.8); }
            100% { transform: scale(1); }
        }

        #optionsPool {
            width: 95%;
            max-width: 700px;
            margin: 20px auto;
            padding: 15px;
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            justify-content: center;
        }

        #controls {
            position: fixed;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 95%;
            max-width: 800px;
            background: #f7fbf3;
            padding: 10px 0;
            z-index: 1000;
        }
        
        button {
            padding: 8px 12px;
            margin: 2px 3px;
            cursor: pointer;
            border: 2px solid #63a0d8;
            background: #63a0d8;
            color: #fffbef;
            font-size: 28px;
            border-radius: 5px;
        }
        
        .active-mode {
            border: 2px solid #fed16a;
        }
        
        .disabled {
            opacity: 0.6;
            pointer-events: none;
        }

        #results, #score {
            width: 95%;
            max-width: 700px;
            margin: 20px auto;
            padding: 15px;
            border-radius: 10px;
            font-size: 28px;
            display: none;
        }
        
        #results {
            border: 2px solid #734A2E;
            background: #fffbef;
        }
        
        #score {
            color: #FF6820;
            background: #fffbef;
            border: 2px solid #FF6820;
        }
                #sentenceNumber {
                        width: 70px;
                        height: 30px;
                        text-align: center;
                        font-size: 20px;
                        border: 2px solid #63a0d8;
                        border-radius: 5px;
                        margin: 0 5px;
                }
        @media (max-width: 768px) {
            body {
                padding-bottom: 220px;
            }
            
            button {
                font-size: 20px;
            }
            
            .word-btn {
                font-size: 28px;
                padding: 8px 14px;
            }
        }
    </style>
</head>
<body>
    <div id="gameContainer">
        <div id="infoBox">习得越南语<br>语法 - 排序练习</div>
        <div id="contactBox">讲师-阮玉煌 | Weixin：XiDeYueNanYu</div>
        <div id="instructionBox">把词语按正确顺序排列 </div>

        <div id="indicator"></div>
        <div id="indicator2"></div>
        <div id="optionsPool"></div>

        <div id="results"></div>
        <div id="score">0/0</div>
    </div>

    <div id="controls">
        <div>
            <button id="freeModeBtn" class="active-mode">自由模式</button>
            <button id="testModeBtn">作业模式</button>
        </div>
        <div>
            <button id="autoContinueBtn">自动继续</button>
            <button id="showHideBtn">显示-隐藏</button>
        </div>
        <div>
            <button id="prevBtn">◀</button>
            <input type="text" id="sentenceNumber" inputmode="numeric">
            <button id="nextBtn">▶</button>
            <button id="replayBtn">再听一遍</button>
        </div>
    </div>

    <audio id="mainAudio"></audio>
    <audio id="correctAudio" src="Dung.mp3"></audio>
    <audio id="wrongAudio" src="Sai.mp3"></audio>

    <script>

const sentences = [
    {
        "audioFile": "audio.mp3",
        "start": 0.302292,
        "end": 1.142292,
        "correctAnswer": "【Chào】【ông】.",
        "translation": "您好，先生。"
    },
    {
        "audioFile": "audio.mp3",
        "start": 1.652292,
        "end": 2.592292,
        "correctAnswer": "【Chào】【bà】.",
        "translation": "您好，女士。"
    },
    {
        "audioFile": "audio.mp3",
        "start": 7.012292,
        "end": 7.902292,
        "correctAnswer": "【Chào】【anh】.",
        "translation": "你好，哥哥/先生。"
    },
    {
        "audioFile": "audio.mp3",
        "start": 8.442292,
        "end": 9.402292,
        "correctAnswer": "【Chào】【các】【anh】.",
        "translation": "你好，各位哥哥/先生。"
    },
    {
        "audioFile": "audio.mp3",
        "start": 11.622292,
        "end": 12.512292,
        "correctAnswer": "【Chào】【chị】.",
        "translation": "你好，姐姐/女士。"
    },
    {
        "audioFile": "audio.mp3",
        "start": 13.032292,
        "end": 14.022292,
        "correctAnswer": "【Chào】【các】【chị】.",
        "translation": "你好，各位姐姐/女士。"
    },
    {
        "audioFile": "audio.mp3",
        "start": 14.672292,
        "end": 15.602292,
        "correctAnswer": "【Chào】【thầy】.",
        "translation": "你好，男老师。"
    },
    {
        "audioFile": "audio.mp3",
        "start": 15.952292,
        "end": 16.912292,
        "correctAnswer": "【Chào】【cô】.",
        "translation": "你好，女老师。"
    },
    {
        "audioFile": "audio.mp3",
        "start": 17.542292,
        "end": 19.122292,
        "correctAnswer": "【Chào】【các】【thầy】【các】【cô】.",
        "translation": "各位老师好。"
    },
    {
        "audioFile": "audio.mp3",
        "start": 19.732292,
        "end": 21.012292,
        "correctAnswer": "【Chào】【các】【thầy cô】.",
        "translation": "各位老师好（男/女）。"
    },
    {
        "audioFile": "audio.mp3",
        "start": 21.492292,
        "end": 22.372292,
        "correctAnswer": "【Chào】【bạn】.",
        "translation": "你好，朋友。"
    },
    {
        "audioFile": "audio.mp3",
        "start": 22.692292,
        "end": 23.882292,
        "correctAnswer": "【Chào】【các】【bạn】.",
        "translation": "你好，各位朋友。"
    },
    {
        "audioFile": "audio.mp3",
        "start": 24.262292,
        "end": 25.202292,
        "correctAnswer": "【Chào】【cậu】.",
        "translation": "你好，小伙子。"
    },
    {
        "audioFile": "audio.mp3",
        "start": 25.682292,
        "end": 26.592292,
        "correctAnswer": "【Chào】【em】.",
        "translation": "你好，小朋友/学弟学妹。"
    },
    {
        "audioFile": "audio.mp3",
        "start": 27.102292,
        "end": 28.122292,
        "correctAnswer": "【Chào】【cháu】.",
        "translation": "你好，小孩子/晚辈。"
    },
    {
        "audioFile": "audio.mp3",
        "start": 28.642292,
        "end": 29.772292,
        "correctAnswer": "【Chào】【các】【cháu】.",
        "translation": "你们好，小朋友们/晚辈们。"
    },
    {
        "audioFile": "audio.mp3",
        "start": 30.332292,
        "end": 32.322292,
        "correctAnswer": "【Chào】【cô】. 【Em】【là】【An】.",
        "translation": "老师好。我是阿安。"
    },
    {
        "audioFile": "audio.mp3",
        "start": 34.292292,
        "end": 36.392292,
        "correctAnswer": "【Chào】【em】. 【Cô】【là】【Mai】.",
        "translation": "你好。我是阿梅老师。"
    },
    {
        "audioFile": "audio.mp3",
        "start": 36.842292,
        "end": 39.032292,
        "correctAnswer": "【Chào】【thầy】. 【Em】【là】【Ba】.",
        "translation": "老师好。我是阿三。"
    },
    {
        "audioFile": "audio.mp3",
        "start": 39.452292,
        "end": 41.582292,
        "correctAnswer": "【Chào】【em】. 【Tôi】【là】【Lê】.",
        "translation": "你好。我是阿丽。"
    },
    {
        "audioFile": "audio.mp3",
        "start": 41.952292,
        "end": 46.532292,
        "correctAnswer": "【Chào】【thầy】. 【Chúng em】【là】【Mai, Lê】, 【và Lan】.",
        "translation": "老师好。我们是阿梅、阿丽和阿兰。"
    },
    {
        "audioFile": "audio.mp3",
        "start": 50.042292,
        "end": 53.532292,
        "correctAnswer": "【Chào】【anh】. 【Chúng tôi】【là】【An】【và Hòa】.",
        "translation": "哥哥好。我们是阿安和阿和。"
    }
];

        let currentIndex = 0;
        let isFreeMode = true;
        let autoContinue = false;
        let showTranslation = true;
        let correctCount = 0;
        let userAnswers = [];
        let selectedWords = [];
        let isChecking = false;
        let isAudioPlaying = false;

        const audio = document.getElementById('mainAudio');
        const correctAudio = document.getElementById('correctAudio');
        const wrongAudio = document.getElementById('wrongAudio');
        const indicator = document.getElementById('indicator');
        const indicator2 = document.getElementById('indicator2');
        const optionsPool = document.getElementById('optionsPool');
        const sentenceNumber = document.getElementById('sentenceNumber');
        const scoreDisplay = document.getElementById('score');
        const resultsDisplay = document.getElementById('results');

        function init() {
            userAnswers = new Array(sentences.length).fill(null);
            updateDisplay();
        }

        function updateDisplay() {
            sentenceNumber.value = currentIndex + 1;
            const s = sentences[currentIndex];
            
            if (showTranslation) {
                indicator.innerHTML = `<div style="color:#63a0d8;font-size:0.6em;">${s.translation}</div>`;
            } else {
                indicator.innerHTML = '';
            }

            const words = s.correctAnswer.match(/【(.*?)】/g).map(t => t.slice(1,-1));
            const shuffled = shuffleArray(words);

            optionsPool.innerHTML = '';
            indicator2.innerHTML = '';
            indicator2.className = '';
            selectedWords = [];
            isChecking = false;

            shuffled.forEach(word => {
                const btn = document.createElement('div');
                btn.className = 'word-btn';
                btn.textContent = word;
                btn.onclick = () => selectWord(word, btn);
                optionsPool.appendChild(btn);
            });

            document.getElementById('prevBtn').classList.toggle('disabled', !isFreeMode && currentIndex === 0);
        }

        function selectWord(word, btn) {
            if (btn.classList.contains('used')) {
                const idx = selectedWords.indexOf(word);
                if (idx > -1) {
                    selectedWords.splice(idx, 1);
                    btn.classList.remove('used');
                    renderAnswerArea();
                }
                return;
            }

            selectedWords.push(word);
            btn.classList.add('used');
            renderAnswerArea();

            indicator2.classList.remove('correct', 'wrong');
            
            if (selectedWords.length === getCorrectWords().length && !isChecking) {
                isChecking = true;
                setTimeout(checkAnswer, 400);
            }
        }

        function renderAnswerArea() {
            indicator2.innerHTML = '';
            selectedWords.forEach((word, i) => {
                const btn = document.createElement('div');
                btn.className = 'word-btn word-btn-in-answer';
                btn.textContent = word;
                btn.onclick = () => {
                    selectedWords.splice(i, 1);
                    renderAnswerArea();
                    Array.from(optionsPool.children).find(b => b.textContent === word)?.classList.remove('used');
                    isChecking = false;
                    indicator2.classList.remove('correct', 'wrong');
                };
                indicator2.appendChild(btn);
            });
        }

        function getCorrectWords() {
            return sentences[currentIndex].correctAnswer.match(/【(.*?)】/g).map(t => t.slice(1,-1));
        }

        function getCorrectAnswerWithSpaces() {
            const words = getCorrectWords();
            return words.join(' ');
        }

        function checkAnswer() {
            const userStr = selectedWords.join('');
            const correctStr = getCorrectWords().join('');
            const isCorrect = userStr === correctStr;

            if (!isFreeMode && userAnswers[currentIndex] === null) {
                userAnswers[currentIndex] = selectedWords.join(' ');
                if (isCorrect) correctCount++;
                updateScore();
            }

            if (isCorrect) {
                indicator2.classList.add('correct');
                indicator2.classList.remove('wrong');
                correctAudio.play();
                playOriginalSentenceExactly();
            } else {
                indicator2.classList.add('wrong');
                wrongAudio.play();
                
                // Trong chế độ 作业模式, phát âm thanh ngay cả khi sai
                if (!isFreeMode) {
                    playOriginalSentenceExactly();
                }
            }

            const delay = 1200;
            
            const moveToNextSentence = () => {
                if (isFreeMode) {
                    if (autoContinue && isCorrect) {
                        nextSentence();
                    }
                } else {
                    if (currentIndex < sentences.length - 1) {
                        currentIndex++;
                        updateDisplay();
                    } else {
                        showFinalResults();
                    }
                }
            };
            
            setTimeout(() => {
                if (!isAudioPlaying) {
                    moveToNextSentence();
                } else {
                    const checkAudioEnd = setInterval(() => {
                        if (!isAudioPlaying) {
                            clearInterval(checkAudioEnd);
                            moveToNextSentence();
                        }
                    }, 100);
                }
            }, delay);
        }

        function playOriginalSentenceExactly() {
            const s = sentences[currentIndex];
            audio.src = s.audioFile;
            audio.currentTime = s.start;
            isAudioPlaying = true;
            audio.play();

            const stopAtEnd = () => {
                if (audio.currentTime >= s.end) {
                    audio.pause();
                    isAudioPlaying = false;
                    audio.removeEventListener('timeupdate', stopAtEnd);
                }
            };
            audio.addEventListener('timeupdate', stopAtEnd);
            
            audio.addEventListener('ended', () => {
                isAudioPlaying = false;
            });
        }

        document.getElementById('replayBtn').onclick = playOriginalSentenceExactly;

        function showFinalResults() {
            let text = `练习完成！\n正确：${correctCount}/${sentences.length}（${(correctCount/sentences.length*100).toFixed(1)}%）\n\n`;
            
            let hasWrong = false;
            let wrongQuestionsText = "错题回顾：\n";
            
            for (let i = 0; i < sentences.length; i++) {
                const correctWords = getCorrectWordsFromSentence(sentences[i]);
                const correctAnswerWithSpaces = correctWords.join(' ');
                
                if (userAnswers[i] && userAnswers[i] !== correctAnswerWithSpaces) {
                    hasWrong = true;
                    wrongQuestionsText += `${i+1}. ${sentences[i].translation}\n   你的答案: ${userAnswers[i]}\n   正确答案: ${correctAnswerWithSpaces}\n\n`;
                }
            }
            
            if (hasWrong) {
                text += wrongQuestionsText;
            } else {
                text += "全对！太厉害了！";
            }
            
            resultsDisplay.textContent = text;
            resultsDisplay.style.display = 'block';
            scoreDisplay.style.display = 'none';
        }

        function getCorrectWordsFromSentence(sentence) {
            return sentence.correctAnswer.match(/【(.*?)】/g).map(t => t.slice(1,-1));
        }

        function updateScore() {
            scoreDisplay.textContent = `${correctCount}/${sentences.length}`;
        }

        function nextSentence() {
            if (currentIndex < sentences.length - 1) {
                currentIndex++;
                updateDisplay();
            } else if (isFreeMode) {
                currentIndex = 0;
                updateDisplay();
            }
        }

        function prevSentence() {
            if (currentIndex > 0) {
                currentIndex--;
                updateDisplay();
            } else if (isFreeMode) {
                currentIndex = sentences.length - 1;
                updateDisplay();
            }
        }

        function shuffleArray(a) {
            const arr = [...a];
            for (let i = arr.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [arr[i], arr[j]] = [arr[j], arr[i]];
            }
            return arr;
        }

        document.getElementById('freeModeBtn').onclick = () => {
            isFreeMode = true;
            document.getElementById('freeModeBtn').classList.add('active-mode');
            document.getElementById('testModeBtn').classList.remove('active-mode');
            scoreDisplay.style.display = 'none';
            resultsDisplay.style.display = 'none';
            updateDisplay();
        };

        document.getElementById('testModeBtn').onclick = () => {
            isFreeMode = false;
            document.getElementById('testModeBtn').classList.add('active-mode');
            document.getElementById('freeModeBtn').classList.remove('active-mode');
            scoreDisplay.style.display = 'block';
            resultsDisplay.style.display = 'none';
            currentIndex = 0;
            correctCount = 0;
            userAnswers = new Array(sentences.length).fill(null);
            updateDisplay();
        };

        document.getElementById('prevBtn').onclick = () => {
            if (isFreeMode) {
                prevSentence();
            } else if (currentIndex > 0) {
                currentIndex--;
                updateDisplay();
            }
        };
        
        document.getElementById('nextBtn').onclick = () => {
            if (isFreeMode) {
                nextSentence();
            } else if (currentIndex < sentences.length - 1) {
                currentIndex++;
                updateDisplay();
            }
        };

        document.getElementById('autoContinueBtn').onclick = () => {
            autoContinue = !autoContinue;
            document.getElementById('autoContinueBtn').classList.toggle('active-mode', autoContinue);
        };

        document.getElementById('showHideBtn').onclick = () => {
            showTranslation = !showTranslation;
            document.getElementById('showHideBtn').classList.toggle('active-mode', showTranslation);
            updateDisplay();
        };

        sentenceNumber.onchange = () => {
            if (isFreeMode) {
                const n = parseInt(sentenceNumber.value) - 1;
                if (n >= 0 && n < sentences.length) { 
                    currentIndex = n; 
                    updateDisplay(); 
                }
            }
        };

        init();
    </script>
</body>
</html>